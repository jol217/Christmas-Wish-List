<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>X-Mas List</title>
        <script src="./dist/purify.js"></script>
    </head>
    <body onload="getWishList(loadHomepage)">
        <h1 id="welcome">Welcome, &nbsp;</h1>
        <nav>
            <div>

            </div>
            <div>
                <input type="button" value="Add Item" id="openAdd"></input>
                <button onclick="handleLogOut()">Log Out</button>
            </div>
        </nav>
        <section>
          <ul id='wList'></ul>
        </section>

        <dialog id="addModal">
            <label>Item:</label>
            <input type="text" id="addName">
            <br>
            <br>
            <label>Price:</label>
            <input type="number" step="0.01" value="0.00" id="addPrice">
            <br>
            <br>
            <label>Category:</label>
            <input type="text" id="addCategory">
            <br>
            <br>
            <label>Image:</label>
            <input type="file" id="addPic" accept="image/png, image/jpeg">
            <br>
            <br>
            <label>Comment:</label>
            <input type="text" id="addComment">
            <br>
            <input type="button" id="closeAdd" value="Cancel"></input>
            <input type="button" id="saveNewItem" value="Save" ></input>
        </dialog>



        <script>
            let accessTok;
            let userName = localStorage.getItem("userName");
            document.getElementById("welcome").innerHTML += userName + "!";


            let addModal    = document.getElementById("addModal");
            let openAdd     = document.getElementById("openAdd");
            let closeAdd    = document.getElementById("closeAdd");
            let saveNewItem = document.getElementById("saveNewItem");

            let addName     = document.getElementById("addName");
            let addPrice    = document.getElementById("addPrice");
            let addCategory = document.getElementById("addCategory");
            let addPic      = document.getElementById("addPic");
            let addComment  = document.getElementById("addComment");



            function loadHomepage(wishList){

                console.log("Loaded Homepage");
                console.log(wishList);
                updateList(wishList.wishItems);

            }

            function makeLi(item){
              let li = document.createElement("li");
              li.appendChild(document.createTextNode(item.item));
              li.appendChild(document.createElement("br"));
              li.appendChild(document.createTextNode(item.price));
              li.appendChild(document.createElement("br"));
              li.appendChild(document.createTextNode(item.category));
              li.appendChild(document.createElement("br"));
              li.appendChild(document.createTextNode(item.image));
              li.appendChild(document.createElement("br"));
              li.appendChild(document.createTextNode(item.comment));
              return li;
            }

            function updateList(wishList){
              let ul = document.getElementById("wList");
              ul.innerHTML="";


              for( let i = 0; i < wishList.length; i++ ){
                console.log("in");
                let item = wishList[i];

                let li = makeLi(item);

                // Create & append edite

                // Create & append delete

                ul.appendChild(li);
              }
            }

            function getWishList(callback){
                accessTok = localStorage.getItem("sessTok");

                if(accessTok === 'null'){
                    console.log("hit");
                    location.replace('login.html');
                }

                let wishList;
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function(){
                    if(this.readyState == 4){
                        wishList = JSON.parse(xhttp.responseText);
                        callback(wishList);
                    }
                }

                xhttp.open("GET", "http://fa19server.appspot.com/api/wishlists/myWishList?access_token="+accessTok);
                xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhttp.send();
            }

            function handleLogOut(){
                var xhttp = new XMLHttpRequest();
                let token = localStorage.getItem("sessTok");
                console.log(token);
                xhttp.onreadystatechange = function(){
                    if(this.readyState == 4 && this.status == 204){
                        localStorage.setItem("sessTok", null);
                        localStorage.setItem("userName", null);
                        location.replace('login.html');
                    }
                };
                xhttp.open("POST", "http://fa19server.appspot.com/api/Users/logout?access_token=" + token, true);
                xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhttp.send();
            }

            openAdd.addEventListener('click', ()=> {
                addModal.showModal();
            });

            closeAdd.addEventListener('click', ()=> {
                addModal.close();
            });

            saveNewItem.addEventListener('click', ()=> {
                var xhttp = new XMLHttpRequest();

                let newAddName     = encodeURIComponent(DOMPurify.sanitize(addName.value));
                let newAddPrice    = addPrice.value;
                let newAddCategory = encodeURIComponent(DOMPurify.sanitize(addCategory.value));
                let newAddImage    = "TODO";
                let newAddComment  = encodeURIComponent(DOMPurify.sanitize(addComment.value));

                let data = 'item='      + newAddName +
                           '&price='    + newAddPrice +
                           '&category=' + newAddCategory +
                           '&image='    + newAddImage    +
                           '&comment='  + newAddComment;

                xhttp.onreadystatechange = function(){
                    if(this.readyState == 4){
                        console.log(xhttp.responseText);
                        getWishList(loadHomepage);
                    }
                };
                xhttp.open("POST", "http://fa19server.appspot.com/api/wishlists?access_token=" + accessTok, true);
                xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhttp.send(data);

                addModal.close();
            });




        </script>
    </body>
</html>
