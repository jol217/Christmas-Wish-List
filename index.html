<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>X-Mas List</title>
        <script src="./dist/purify.js"></script>

        <!-- <style>
            .starRating:not(old){
              display        : inline-block;
              width          : 7.5em;
              height         : 1.5em;
              overflow       : hidden;
              vertical-align : bottom;
            }
            .starRating:not(old) > input{
              margin-right : -100%;
              opacity      : 0;
            }
            .starRating:not(old) > label{
              display         : block;
              float           : right;
              position        : relative;
              background      : url('star-off.svg');
              background-size : contain;
            }
            .starRating:not(old) > label:before{
              content         : '';
              display         : block;
              width           : 1.5em;
              height          : 1.5em;
              background      : url('star-on.svg');
              background-size : contain;
              opacity         : 0;
              transition      : opacity 0.2s linear;
            }
            .starRating:not(old) > label:hover:before,
            .starRating:not(old) > label:hover ~ label:before,
            .starRating:not(:hover) > :checked ~ label:before{
              opacity : 1;
            }
        </style> -->
    </head>

    <body onload="getWishList(loadHomepage)">

        <nav>
            <div>
              <h1 id="welcome">Welcome, &nbsp;</h1>
            </div>
            <div>
                <input type="button" value="Add Item" id="openAdd"></input>
                <button onclick="handleLogOut()">Log Out</button>
            </div>
        </nav>

        <section>
          <ul id='wList'></ul>
        </section>
        <!-- <img src="https://upload.wikimedia.org/wikipedia/commons/1/13/Benedict_Cumberbatch_2011.png" alt="Yellow bouquet" /> -->

        <dialog id="addModal">
            <label>Item:</label>
            <input type="text" id="addName">
            <br>
            <br>
            <label>Price:</label>
            <input type="number" step="0.01" value="0.00" id="addPrice">
            <br>
            <br>
            <label>Category:</label>
            <input type="text" id="addCategory">
            <br>
            <br>
            <label>Image:</label>
            <input type="text" id="addPic">
            <br>
            <br>
            <label>Comment:</label>
            <input type="text" id="addComment">
            <br>
            <input type="button" id="cancelAdd" value="Cancel"></input>
            <input type="button" id="saveNewItem" value="Save" ></input>
        </dialog>

        <dialog id="editModal">
            <label>Item:</label>
            <input type="text" id="editName">
            <br>
            <br>
            <label>Price:</label>
            <input type="number" step="0.01" value="0.00" id="editPrice">
            <br>
            <br>
            <label>Category:</label>
            <input type="text" id="editCategory">
            <br>
            <br>
            <label>Image:</label>
            <input type="text" id="editPic">
            <br>
            <br>
            <label>Comment:</label>
            <input type="text" id="editComment">
            <br>
            <input type="button" id="cancelEdit" value="Cancel"></input>
        </dialog>

        <dialog id="deleteModal">
          <p>Delete movie?</p>
          <br/>
          <input type="button" id="cancelDelete" value="Cancel"></input>
        </dialog>



        <script>
            let accessTok;
            let userName = localStorage.getItem("userName");
            document.getElementById("welcome").innerHTML += userName + "!";






            let addModal    = document.getElementById("addModal");
            let openAdd     = document.getElementById("openAdd");
            let cancelAdd   = document.getElementById("cancelAdd");
            let saveNewItem = document.getElementById("saveNewItem");

            let editModal    = document.getElementById("editModal");
            let editName     = document.getElementById("editName");
            let editPrice    = document.getElementById("editPrice");
            let editCategory = document.getElementById("editCategory");
            let editPic      = document.getElementById("editPic");
            let editComment  = document.getElementById("editComment");
            let cancelEdit   = document.getElementById("cancelEdit");

            let deleteModal = document.getElementById("deleteModal");
            let cancelDelete = document.getElementById("cancelDelete");

            let addName     = document.getElementById("addName");
            let addPrice    = document.getElementById("addPrice");
            let addCategory = document.getElementById("addCategory");
            let addPic      = document.getElementById("addPic");
            let addComment  = document.getElementById("addComment");





            function loadHomepage(wishList){

                console.log("Loaded Homepage");
                console.log(wishList);
                updateList(wishList.wishItems);

            }

            function makeLi(item){
              let li = document.createElement("li");
              //let itemPic = document.createElement("IMG");
              //itemPic.src = URL.createObjectURL(item.pic);
            //  li.appendChild(itemPic);
              toDataURL(item.image, function(dataUrl) {
                  console.log('Result in string:', dataUrl);
                  var image = new Image();
                  image.src = dataUrl;
                  image.style.width = '200px'
                  image.style.height = '200px'
                  li.appendChild(image);
                  li.appendChild(document.createElement("br"));
                  li.appendChild(document.createTextNode(item.item));
                  li.appendChild(document.createElement("br"));
                  li.appendChild(document.createTextNode(item.price));
                  li.appendChild(document.createElement("br"));
                  li.appendChild(document.createTextNode(item.category));
                  li.appendChild(document.createElement("br"));
                  // li.appendChild(document.createTextNode(item.image));
                  // li.appendChild(document.createElement("br"));
                  li.appendChild(document.createTextNode(item.comment));
                  li.appendChild(document.createElement("br"));

              });


              return li;
            }

            function updateList(wishList){
              let ul = document.getElementById("wList");
              ul.innerHTML="";


              for( let i = 0; i < wishList.length; i++ ){
                console.log("in");
                let item = wishList[i];

                let li = makeLi(item);

                // Create & append edite

                let editBtn = document.createElement("input");
                editBtn.type = "button";
                editBtn.value = "edit"
                editBtn.id = "e" + item.id;

                editBtn.addEventListener('click', function(){
                  let confirmEdit = document.createElement("input");
                  confirmEdit.type = "button";
                  confirmEdit.value = "Save changes";
                  confirmEdit.id = this.id;

                  confirmEdit.addEventListener('click', function(){
                      let itemId = this.id.substring(1);
                      var xhttp = new XMLHttpRequest();

                      let eName  = encodeURIComponent(DOMPurify.sanitize(editName.value));
                      let ePrice = editPrice.value;
                      let eCategory = encodeURIComponent(DOMPurify.sanitize(editCategory.value));
                      let ePic   = encodeURIComponent(editPic.value);
                      let eComment = encodeURIComponent(DOMPurify.sanitize(editComment.value));

                      let data = "item=" + eName + "&price=" + ePrice + "&category=" + eCategory + "&image=" + ePic + "&comment=" + eComment;

                      xhttp.onreadystatechange = function(){
                        if(this.readyState == 4){
                          console.log(xhttp.responseText);
                          editModal.close();
                          getWishList(loadHomepage);
                        }
                      }
                      xhttp.open("POST", "http://fa19server.appspot.com/api/wishlists/" + itemId + "/replace?access_token=" + accessTok);
                      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                      xhttp.send(data);
                  });
                  editName.value = item.item;
                  editPrice.value = item.price;
                  editCategory.value = item.category;
                  editPic.value = item.image;
                  editComment.value = item.comment;
                  editModal.removeChild(editModal.lastChild);
                  editModal.appendChild(confirmEdit);
                  editModal.showModal();
                });


                let deleteBtn = document.createElement("input");
                deleteBtn.type = "button";
                deleteBtn.value = "delete";
                deleteBtn.id = "d" + item.id;

                deleteBtn.addEventListener('click', function(){
                  let confirmDelete = document.createElement("input");
                  confirmDelete.type = "button";
                  confirmDelete.value = "Ok";
                  confirmDelete.id = this.id;

                  confirmDelete.addEventListener('click', function(){
                      let itemId = this.id.substring(1);
                      var xhttp = new XMLHttpRequest();

                      xhttp.onreadystatechange = function(){
                          if(this.readyState == 4){
                              console.log(xhttp.responseText);
                              deleteModal.close();
                              getWishList(loadHomepage);
                          }
                      };

                      xhttp.open("DELETE", "http://fa19server.appspot.com/api/wishlists/" + itemId + "?access_token=" + accessTok, true);
                      xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                      xhttp.send();

                  });

                  deleteModal.removeChild(deleteModal.lastChild);
                  deleteModal.appendChild(confirmDelete);
                  deleteModal.showModal();
                });

                // let starRating = makeRating(item.id);
                //
                // addListener("r"+ item.id);
                //
                // li.appendChild(starRating);


                setTimeout(function(){
                  li.appendChild(deleteBtn);
                  li.appendChild(editBtn);
                }, 300);







                ul.appendChild(li);
                ul.appendChild(document.createElement("br"));
              }
            }

            function getWishList(callback){
                accessTok = localStorage.getItem("sessTok");

                if(accessTok === 'null'){
                    console.log("hit");
                    location.replace('login.html');
                }

                let wishList;
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function(){
                    if(this.readyState == 4){
                        wishList = JSON.parse(xhttp.responseText);
                        callback(wishList);
                    }
                }

                xhttp.open("GET", "http://fa19server.appspot.com/api/wishlists/myWishList?access_token="+accessTok);
                xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhttp.send();
            }

            function handleLogOut(){
                var xhttp = new XMLHttpRequest();
                let token = localStorage.getItem("sessTok");
                console.log(token);
                xhttp.onreadystatechange = function(){
                    if(this.readyState == 4 && this.status == 204){
                        localStorage.setItem("sessTok", null);
                        localStorage.setItem("userName", null);
                        location.replace('login.html');
                    }
                };
                xhttp.open("POST", "http://fa19server.appspot.com/api/Users/logout?access_token=" + token, true);
                xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhttp.send();
            }

            openAdd.addEventListener('click', ()=> {
                addModal.showModal();
            });

            cancelAdd.addEventListener('click', ()=> {
                addModal.close();
            });

            saveNewItem.addEventListener('click', ()=> {
                var xhttp = new XMLHttpRequest();

                let newAddName     = encodeURIComponent(DOMPurify.sanitize(addName.value));
                let newAddPrice    = addPrice.value;
                let newAddCategory = encodeURIComponent(DOMPurify.sanitize(addCategory.value));
                let newAddImage    = encodeURIComponent(addPic.value);
                let newAddComment  = encodeURIComponent(DOMPurify.sanitize(addComment.value));

                let data = 'item='      + newAddName +
                           '&price='    + newAddPrice +
                           '&category=' + newAddCategory +
                           '&image='    + newAddImage    +
                           '&comment='  + newAddComment;

                xhttp.onreadystatechange = function(){
                    if(this.readyState == 4){
                        console.log(xhttp.responseText);
                        getWishList(loadHomepage);
                    }
                };
                xhttp.open("POST", "http://fa19server.appspot.com/api/wishlists?access_token=" + accessTok, true);
                xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhttp.send(data);

                addModal.close();

                addName.value     = "";
                addPrice.value    = 0;
                addCategory.value = "";
                addPic.value      = "";
                addComment.value  = "";
            });

            cancelDelete.addEventListener('click', ()=> {
                deleteModal.close();
            });

            cancelEdit.addEventListener('click', ()=>{
                editModal.close();
            });



          // function makeRating(itemId){
          //   let span = document.createElement("span");
          //   span.id = 'rating'+itemId;
          //   span.className = 'starRating';
          //
          //   for ( let i = 5; i > 0; i--){
          //     let input = document.createElement("input");
          //     input.id = "rating" + i;
          //     input.type = "radio";
          //     input.name = "r" + itemId;
          //     input.value = i.toString();
          //
          //     let label =document.createElement("label");
          //     label.for = "rating"+ i;
          //     label.innerHTML = i;
          //
          //
          //     console.log(input.id);
          //     console.log(input.name);
          //
          //
          //     span.appendChild(input);
          //     span.appendChild(label);
          //   }
          //   console.log(span.id);
          //   console.log(span.class);
          //
          //   return span;
          // }
          //
          // function addListener(ratingName){
          //   var ele = document.getElementsByName(ratingName);
          //   var prev = null;
          //   for (var i = 0; i < ele.length; i++) {
          //       ele[i].addEventListener('change', function() {
          //           //(prev) ? console.log(prev.value): null;
          //           if (this !== prev) {
          //               prev = this;
          //           }
          //           console.log(ratingName);
          //           console.log(this.value);
          //
          //       });
          //   }
          // }

          function toDataURL(url, callback) {
           var httpRequest = new XMLHttpRequest();
           httpRequest.onload = function() {
              var fileReader = new FileReader();
                 fileReader.onloadend = function() {
                    callback(fileReader.result);
                 }
                 fileReader.readAsDataURL(httpRequest.response);
           };
           httpRequest.open('GET', url);
           httpRequest.responseType = 'blob';
           httpRequest.send();
        }






        </script>
    </body>
</html>
